{% extends "base.html" %}
{% block title %}Checkout{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-6 py-10">

  <h2 class="text-3xl font-bold text-green-700 mb-8">
    Checkout
  </h2>

  <!-- ORDER SUMMARY -->
  <div class="bg-white shadow rounded-lg p-6 mb-8">

    <h3 class="text-xl font-semibold mb-4">
      Order Summary
    </h3>

    <table class="w-full border-collapse">
      <thead>
        <tr class="border-b">
          <th class="text-left py-2">Crop</th>
          <th class="text-left py-2">Price / 20 KG</th>
          <th class="text-left py-2">Quantity</th>
          <th class="text-left py-2">Subtotal</th>
        </tr>
      </thead>

      <tbody>
        {% for item in items %}
        <tr class="border-b">
          <td class="py-2">{{ item.product.crop|title }}</td>
          <td class="py-2">₹{{ item.product.price }}</td>
          <td class="py-2">{{ item.quantity }} KG</td>
          <td class="py-2 font-semibold">
            ₹{{ item.subtotal }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="flex justify-end mt-4 text-lg font-bold">
      Total: <span class="text-green-700 ml-2">₹{{ total }}</span>
    </div>

  </div>

  <!-- SHIPPING INFO -->
  <div class="bg-white shadow rounded-lg p-6 mb-8">

    <h3 class="text-xl font-semibold mb-4">
      Shipping Details
    </h3>

    <form method="POST" action="{% url 'checkout' %}">
      {% csrf_token %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <input type="text" name="fullname" id="fullname" placeholder="Full Name" class="border p-3 rounded" required>

        <input type="text" name="mobile" id="mobile" placeholder="Mobile Number" class="border p-3 rounded" required>

        <input type="text" name="city" id="city" placeholder="City" class="border p-3 rounded" required>

        <input type="text" name="pincode" id="pincode" placeholder="Pincode" class="border p-3 rounded" required>

      </div>

      <textarea name="address" placeholder="Full Address" class="border p-3 rounded w-full mt-4" rows="3"
        required></textarea>

      <!-- PAYMENT SELECTION -->
      <div class="bg-white shadow rounded-lg p-6 mb-8">
        <h3 class="text-xl font-semibold mb-4">
          Select Payment Method
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

          <!-- UPI -->
          <label class="border rounded-lg p-4 cursor-pointer hover:border-green-600
                  has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
            <input type="radio" name="payment_method" value="UPI" class="hidden" required>
            <div class="text-center">
              <p class="text-lg font-semibold">UPI</p>
              <p class="text-sm text-gray-500 mt-1">
                GPay, PhonePe, Paytm
              </p>
            </div>
          </label>

          <!-- CARD -->
          <label class="border rounded-lg p-4 cursor-pointer hover:border-green-600
              has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
            <input type="radio" name="payment_method" value="CARD" class="hidden" required>
            <div class="text-center">
              <p class="text-lg font-semibold">Card</p>
              <p class="text-sm text-gray-500 mt-1">
                Debit / Credit
              </p>
            </div>
          </label>


          <!-- COD -->
          <label class="border rounded-lg p-4 cursor-pointer hover:border-green-600
                  has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
            <input type="radio" name="payment_method" value="COD" class="hidden">
            <div class="text-center">
              <p class="text-lg font-semibold">COD</p>
              <p class="text-sm text-gray-500 mt-1">
                Pay on Delivery
              </p>
            </div>
          </label>

        </div>
      </div>

      <!-- DYNAMIC PAYMENT FIELDS -->
      <!-- DYNAMIC PAYMENT FIELDS -->
      <div class="mt-6 space-y-4">

        <!-- CARD FIELDS -->
        <div id="card-fields" class="hidden bg-gray-50 p-4 rounded-lg border">
          <h4 class="font-semibold mb-3">Card Details</h4>

          <input type="text" name="cardnumber" id="cardnumber" maxlength="16" placeholder="Card Number"
            class="w-full px-4 py-3 border rounded" />

          <input type="text" name="cardholdername" id="cardholdername" placeholder="Cardholder Name"
            class="w-full px-4 py-3 border rounded" />

          <input type="text" name="expiry" id="expiry" placeholder="Expiry (MM/YY)"
            class="w-full px-4 py-3 border rounded" />

          <input type="text" name="cvv" id="cvv" placeholder="CVV" class="w-full px-4 py-3 border rounded" />
        </div>

        <!-- UPI FIELD -->
        <div id="upi-fields" class="hidden bg-gray-50 p-4 rounded-lg border">
          <h4 class="font-semibold mb-3">UPI ID</h4>
          <input type="text" name="upi_id" id="upi_id" placeholder="yourname@upi" class="border p-3 rounded w-full">
        </div>

      </div>



      <div class="flex justify-start pt-4">
<a href="/order_success">
    <button type="submit" class="cssbuttons-io-button">
    Place Order
    <div class="icon">
      <svg height="24" width="24" viewBox="0 0 24 24">
        <path d="M0 0h24v24H0z" fill="none"></path>
        <path
          d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"
          fill="currentColor"></path>
      </svg>
    </div>
  </button>
</a>
  </div>
    </form>

  </div>

</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {

    /* ========= INPUT RESTRICTIONS ========= */

    const fullname = document.getElementById("fullname");
    fullname?.addEventListener("input", e => {
      e.target.value = e.target.value.replace(/[^a-zA-Z\s]/g, "");
    });

    const mobile = document.getElementById("mobile");
    mobile?.addEventListener("input", e => {
      e.target.value = e.target.value.replace(/\D/g, "").slice(0, 10);
    });

    const city = document.getElementById("city");
    city?.addEventListener("input", e => {
      e.target.value = e.target.value.replace(/[^a-zA-Z\s]/g, "");
    });

    const pincode = document.getElementById("pincode");
    pincode?.addEventListener("input", e => {
      e.target.value = e.target.value.replace(/\D/g, "").slice(0, 6);
    });

    const upi = document.getElementById("upi_id");
    upi?.addEventListener("input", e => {
      e.target.value = e.target.value.replace(/[^a-zA-Z0-9.@_-]/g, "");
    });

    const cardNumber = document.getElementById("cardnumber");
    cardNumber?.addEventListener("input", e => {
      e.target.value = e.target.value.replace(/\D/g, "").slice(0, 16);
    });

    const cardHolder = document.getElementById("cardholdername");
    cardHolder?.addEventListener("input", e => {
      e.target.value = e.target.value.replace(/[^a-zA-Z\s]/g, "");
    });

    const cvv = document.getElementById("cvv");
    cvv?.addEventListener("input", e => {
      e.target.value = e.target.value.replace(/\D/g, "").slice(0, 3);
    });

    const expiry = document.getElementById("expiry");
    expiry?.addEventListener("input", e => {
      let v = e.target.value.replace(/\D/g, "").slice(0, 4);
      if (v.length >= 3) v = v.slice(0, 2) + "/" + v.slice(2);
      e.target.value = v;
    });

    /* ========= PAYMENT METHOD TOGGLE ========= */

    const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
    const cardFields = document.getElementById("card-fields");
    const upiFields = document.getElementById("upi-fields");

    paymentRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        cardFields.classList.add("hidden");
        upiFields.classList.add("hidden");

        if (radio.value === "CARD") cardFields.classList.remove("hidden");
        if (radio.value === "UPI") upiFields.classList.remove("hidden");
      });
    });

    /* ========= FINAL SUBMIT VALIDATION ========= */

    const form = document.querySelector("form");

    form.addEventListener("submit", e => {
      const method = document.querySelector('input[name="payment_method"]:checked');
      if (!method) return;

      if (method.value === "CARD") {
        const parts = expiry.value.split("/");

        if (parts.length !== 2) {
          alert("Invalid expiry date!");
          expiry.focus();
          e.preventDefault();
          return;
        }

        const m = parseInt(parts[0], 10);
        const y = parseInt(parts[1], 10);

        if (!m || m < 1 || m > 12) {
          alert("Invalid expiry month!");
          expiry.focus();
          e.preventDefault();
          return;
        }

        const now = new Date();
        const curYear = now.getFullYear() % 100;
        const curMonth = now.getMonth() + 1;

        if (y < curYear || (y === curYear && m < curMonth)) {
          alert("Card expiry cannot be in the past!");
          expiry.focus();
          e.preventDefault();
          return;
        }
      }
    });

  });
</script>

{% endblock %}